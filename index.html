<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @keyframes beat {
        from {
          transform: translateY(0);
        }
        to {
          transform: translateY(100%);
        }
      }
    </style>
  </head>
  <body class="bg-black">
    <div
      class="flex flex-col max-w-xl min-h-screen mx-auto bg-gray-900 border-l-2 border-r-2 border-gray-700"
    >
      <div class="grid grid-cols-4 flex-1 overflow-hidden">
        <div id="D" class="relative h-full"></div>
        <div id="F" class="relative h-full"></div>
        <div id="J" class="relative h-full"></div>
        <div id="K" class="relative h-full"></div>
      </div>
      <div class="grid grid-cols-4 h-40">
        <div
          id="d-key"
          class="flex items-center justify-center text-3xl font-bold text-white h-full bg-gray-700 border-r border-gray-900 mt-auto"
        >
          D
        </div>
        <div
          id="f-key"
          class="flex items-center justify-center text-3xl font-bold text-white h-full bg-gray-700 border-l border-r border-gray-900 mt-auto"
        >
          F
        </div>
        <div
          id="j-key"
          class="flex items-center justify-center text-3xl font-bold text-white h-full bg-gray-700 border-l border-r border-gray-900 mt-auto"
        >
          J
        </div>
        <div
          id="k-key"
          class="flex items-center justify-center text-3xl font-bold text-white h-full bg-gray-700 border-l border-gray-900 mt-auto"
        >
          K
        </div>
      </div>
    </div>

    <div id="overlay">
      <div
        class="fixed inset-0 w-full h-full bg-black/70 flex items-center justify-center"
      >
        <h2 id="overlay-title" class="text-white text-5xl font-bold">
          Press Enter to start game
        </h2>
      </div>
    </div>

    <script>
      let animationCss = "";
      let dLine = "";
      let fLine = "";
      let jLine = "";
      let kLine = "";

      const timeToSeconds = (time) => {
        const [minutes, seconds, miliseconds] = time.split(":").map(Number);
        return minutes * 60 + seconds + miliseconds / 1000;
      };

      const createBeat = (id) => {
        return `<div id="beat-${id}" class="absolute w-full h-full transition duration-500">
          <div class="-mt-8 h-8 w-full bg-blue-200 absolute"></div>
        </div>`;
      };

      const renderCss = () => {
        const styleElement = document.createElement("style");
        styleElement.type = "text/css";
        styleElement.innerHTML = animationCss;
        document.head.appendChild(styleElement);
      };

      fetch("./music.json")
        .then((res) => res.json())
        .then((data) => {
          data.beats.forEach((beat, index) => {
            animationCss += `#beat-${index} {
              animation: beat 0.5s;
              animation-delay: ${timeToSeconds(beat.time)}s;
            }`;

            switch (beat.key) {
              case "D":
                dLine += createBeat(index);
                break;
              case "F":
                fLine += createBeat(index);
                break;
              case "J":
                jLine += createBeat(index);
                break;
              case "K":
                kLine += createBeat(index);
                break;
              default:
                break;
            }
          });
        })
        .then(() => {
          document.getElementById("D").innerHTML = dLine;
          document.getElementById("F").innerHTML = fLine;
          document.getElementById("J").innerHTML = jLine;
          document.getElementById("K").innerHTML = kLine;
        });

      let isPlaying = false;

      const handleKey = (key, type) => {
        const keyClassList = document.getElementById(`${key}-key`).classList;
        switch (type) {
          case "down":
            keyClassList.remove("bg-gray-700");
            keyClassList.add("bg-gray-600");
            break;
          default:
            keyClassList.remove("bg-gray-600");
            keyClassList.add("bg-gray-700");
            break;
        }
      };

      const keys = ["d", "f", "j", "k"];

      const overlayElementClassList =
        document.getElementById("overlay").classList;
      const overlayElementTitle = document.getElementById("overlay-title");

      const music = new Audio("./music.mp3");

      const startGame = () => {
        isPlaying = true;

        overlayElementClassList.add("hidden");

        music.play().then(() => {
          renderCss();
        });
      };

      const pauseGame = () => {
        isPlaying = false;
        overlayElementClassList.remove("hidden");
        overlayElementTitle.textContent = "Game paused. Press enter to resume";
        music.pause();
      };

      document.addEventListener("keydown", (e) => {
        if (!isPlaying && e.key === "Enter") {
          startGame();
        }

        if (isPlaying) {
          if (keys.includes(e.key)) {
            handleKey(e.key, "down");
          }

          if (e.key === "Escape") {
            pauseGame();
          }
        }
      });

      document.addEventListener("keyup", (e) => {
        if (isPlaying) {
          if (keys.includes(e.key)) {
            handleKey(e.key, "up");
          }
        }
      });
    </script>
  </body>
</html>
